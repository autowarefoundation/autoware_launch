autoware_system_design_format: v0.1.0

name: Tier4LocalizationWrapper.node

launch:
  package: tier4_localization_launch
  ros2_launch_file: localization.launch.xml

# interfaces
inputs:
  - name: lanelet_map
    message_type: autoware_map_msgs/msg/LaneletMapBin
  - name: pointcloud_map
    message_type: sensor_msgs/msg/PointCloud2
  - name: pointcloud
    message_type: sensor_msgs/msg/PointCloud2
  - name: imu
    message_type: sensor_msgs/msg/Imu
  - name: twist
    message_type: geometry_msgs/msg/TwistWithCovarianceStamped
  - name: gnss_velocity
    message_type: geometry_msgs/msg/TwistWithCovarianceStamped
  - name: gnss_pose_with_covariance
    message_type: geometry_msgs/msg/PoseWithCovarianceStamped
  - name: gnss_nav_sat_fix
    message_type: sensor_msgs/msg/NavSatFix
  - name: sub_gnss_nav_sat_fix
    message_type: sensor_msgs/msg/NavSatFix
  - name: camera_image
    message_type: sensor_msgs/msg/Image
  - name: camera_info
    message_type: sensor_msgs/msg/CameraInfo
  - name: initialization_state
    message_type: autoware_adapi_v1_msgs/msg/LocalizationInitializationState

outputs:
  - name: ros_transform
    message_type: tf2_msgs/msg/TFMessage
    global: /tf
  - name: pose_with_covariance
    message_type: geometry_msgs/msg/PoseWithCovarianceStamped
    qos:
      reliability: reliable
      durability: transient_local
  - name: acceleration
    message_type: geometry_msgs/msg/AccelWithCovarianceStamped
    qos:
      reliability: reliable
      durability: transient_local
  - name: initialization_state
    message_type: autoware_adapi_v1_msgs/msg/LocalizationInitializationState
  - name: kinematic_state
    message_type: nav_msgs/msg/Odometry
  - name: pose_estimator/pose_with_covariance
    message_type: geometry_msgs/msg/PoseWithCovarianceStamped

# parameters
parameter_files: []

parameters:
  - name: pose_source
    default: ndt
  - name: ndt_enabled
    default: true
  - name: gnss_enabled
    default: true
  - name: ekf_enabled
    default: true
  - name: yabloc_enabled
    default: false
  - name: stop_check_enabled
    default: false
  - name: twist_source
    default: gyro_odom
  - name: input_pointcloud
    default: /sensing/lidar/concatenated/pointcloud
  - name: system_run_mode
    default: online
  - name: localization_pointcloud_container_name
    default: /pointcloud_container
  - name: initial_pose
    default: '[]'
  - name: user_defined_initial_pose/enable
    default: false
  - name: user_defined_initial_pose/pose
    default: '[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0]'

  - name: localization_error_monitor_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/localization_error_monitor.param.yaml
  - name: ekf_localizer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ekf_localizer.param.yaml
  - name: stop_filter_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/stop_filter.param.yaml
  - name: pose_instability_detector_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/pose_instability_detector.param.yaml
  - name: pose_initializer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/pose_initializer.param.yaml
  - name: twist2accel_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/twist2accel.param.yaml
  - name: ndt_scan_matcher/ndt_scan_matcher_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ndt_scan_matcher/ndt_scan_matcher.param.yaml
  - name: ndt_scan_matcher/pointcloud_preprocessor/crop_box_filter_measurement_range_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ndt_scan_matcher/pointcloud_preprocessor/crop_box_filter_measurement_range.param.yaml
  - name: ndt_scan_matcher/pointcloud_preprocessor/voxel_grid_downsample_filter_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ndt_scan_matcher/pointcloud_preprocessor/voxel_grid_filter.param.yaml
  - name: ndt_scan_matcher/pointcloud_preprocessor/random_downsample_filter_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ndt_scan_matcher/pointcloud_preprocessor/random_downsample_filter.param.yaml
  - name: camera_pose_initializer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/camera_pose_initializer.param.yaml
  - name: camera_particle_corrector_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/camera_particle_corrector.param.yaml
  - name: gnss_particle_corrector_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/gnss_particle_corrector.param.yaml
  - name: predictor_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/predictor.param.yaml
  - name: graph_segment_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/graph_segment.param.yaml
  - name: segment_filter_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/segment_filter.param.yaml
  - name: undistort_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/undistort.param.yaml
  - name: ground_server_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/ground_server.param.yaml
  - name: ll2_decomposer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/yabloc/ll2_decomposer.param.yaml
  - name: eagleye_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/eagleye_config.param.yaml
  - name: lidar_marker_localizer/lidar_marker_localizer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/lidar_marker_localizer/lidar_marker_localizer.param.yaml
  - name: lidar_marker_localizer/pointcloud_preprocessor/crop_box_filter_measurement_range_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/lidar_marker_localizer/pointcloud_preprocessor/crop_box_filter_measurement_range.param.yaml
  - name: lidar_marker_localizer/pointcloud_preprocessor/ring_filter_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/lidar_marker_localizer/pointcloud_preprocessor/ring_filter.param.yaml
  - name: ar_tag_based_localizer_param_path
    default: $(find-pkg-share autoware_launch)/config/localization/ar_tag_based_localizer.param.yaml

# processes
processes:
  - name: update
    trigger_conditions:
      - or:
          - once: lanelet_map
          - on_input: pointcloud
    outcomes:
      - to_trigger: slam
  - name: slam
    trigger_conditions:
      - periodic: 100 # Hz
    outcomes:
      - to_output: ros_transform
      - to_output: pose_with_covariance

